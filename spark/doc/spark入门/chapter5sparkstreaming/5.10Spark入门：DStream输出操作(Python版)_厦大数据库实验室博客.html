<!DOCTYPE html>
<html lang="zh-CN"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spark入门：DStream输出操作(Python版)_厦大数据库实验室博客</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<link rel="dns-prefetch" href="http://cdn.staticfile.org/">
<link rel="dns-prefetch" href="http://s.w.org/">
<link rel="stylesheet" id="yarppWidgetCss-css" href="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/widget.css" type="text/css" media="all">
<link rel="stylesheet" id="wp-quicklatex-format-css" href="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/quicklatex-format.css" type="text/css" media="all">
<link rel="stylesheet" id="bootstrap-css" href="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/bootstrap.css" type="text/css" media="all">
<link rel="stylesheet" id="font-awesome-css" href="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/font-awesome.css" type="text/css" media="all">
<link rel="stylesheet" id="power-css" href="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/style.css" type="text/css" media="all">
<link rel="stylesheet" id="google-code-prettify-css" href="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/prettify.css" type="text/css" media="all">
<script type="text/javascript" async="" charset="utf-8" src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/core.js"></script><script src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/hm.js"></script><script src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/z_stat.js"></script><script type="text/javascript" src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/jquery_002.js"></script>
<script type="text/javascript" src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/jquery.js"></script>
<script type="text/javascript" src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/jquery-migrate.js"></script>
<script type="text/javascript" src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/wp-quicklatex-frontend.js"></script>
<link rel="https://api.w.org/" href="http://dblab.xmu.edu.cn/blog/wp-json/">
<link rel="prev" title="Spark2.1.0+入门：DStream转换操作(Python版)" href="http://dblab.xmu.edu.cn/blog/1747-2/">
<link rel="next" title="Python：匿名函数" href="http://dblab.xmu.edu.cn/blog/1750-2/">
<link rel="canonical" href="http://dblab.xmu.edu.cn/blog/1749-2/">
<link rel="alternate" type="application/json+oembed" href="http://dblab.xmu.edu.cn/blog/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fdblab.xmu.edu.cn%2Fblog%2F1749-2%2F">
<!--[if lt IE 9]>
<script src="http://dblab.xmu.edu.cn/blog/wp-content/themes/power/js/html5shiv.js"></script>
<![endif]-->
</head>

<body class="post-template-default single single-post postid-1749 single-format-standard group-blog">
<div class="container site-page">

<div class="row">
	<div class="col-sm-3 site-infos">
		<h4 class="site-title">
			<a href="http://dblab.xmu.edu.cn/blog/" title="厦大数据库实验室博客" rel="home">厦大数据库实验室博客</a>
		</h4>
		<div class="site-description">总结、分享、收获<p><a href="http://dblab.xmu.edu.cn/" title="厦大数据库实验室">实验室主页</a></p></div>

		<nav class="main-navigation" role="navigation">
			<div class="menu-primary-container"><ul id="menu-primary" class="menu menu-level-1"><li id="menu-item-80" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/">首页</a></li>
<li id="menu-item-85" class="menu-item item-level-1 current-path"><a href="http://dblab.xmu.edu.cn/blog/category/big-data/">大数据</a></li>
<li id="menu-item-676" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/category/databases/">数据库</a></li>
<li id="menu-item-87" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/category/data-mining/">数据挖掘</a></li>
<li id="menu-item-86" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/category/others/">其他</a></li>
</ul></div>		</nav><!-- #site-navigation -->

		<div class="search"><form role="search" method="get" class="search-form" action="http://dblab.xmu.edu.cn/blog/">
				<label>
					<span class="screen-reader-text">搜索：</span>
					<input class="search-field" placeholder="搜索…" name="s" type="search">
				</label>
				<input class="search-submit" value="搜索" type="submit">
			</form></div>
	</div>
	<div class="col-sm-9 site-main">

					<article id="post-1749" class="post-1749 post type-post status-publish format-standard hentry category-big-data">
	<header class="entry-header">
		<h1 class="entry-title">Spark入门：DStream输出操作(Python版)</h1>

		<div class="entry-meta">
			<span class="author"><i class="fa fa-user"></i> 阮榕城</span><span class="date"><i class="fa fa-calendar"></i> <time datetime="2017-12-13T16:51:46+00:00">2017年12月13日</time> <span class="updated">(updated: <time class="updated" datetime="2017-12-17T20:47:40+00:00">2017年12月17日</time>)</span></span><span class="views" id="views"><i class="fa fa-eye"></i> 2330</span>		</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

	<div class="entry-content">
		<div class="bigdata-book">
			<a href="http://dblab.xmu.edu.cn/post/5899/" title="2019年1月20日寒假大数据师资培训班" target="_blank"><img src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/peixunban2019-01-20.jpg" alt="2019年1月20日寒假大数据师资培训班"></a>
		</div>
		<p>【版权声明】博客内容由厦门大学数据库实验室拥有版权，未经允许，请勿转载！<br>
<a href="http://dblab.xmu.edu.cn/blog/1709-2/" target="_blank">返回Spark教程首页</a></p>
<p>在Spark应用中，外部系统经常需要使用到Spark DStream处理后的数据，因此，需要采用输出操作把DStream的数据输出到数据库或者文件系统中。<br>
<span id="more-1749"></span></p>
<h1>准备工作</h1>
<p>这里依然以前面的“DStream转换操作”章节中介绍的NetworkWordCountStateful.py为基础进行修改。下面，让我们先调试一遍这个程序，复习一下整个程序的细节。<br>
请登录Linux系统，打开一个终端：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">cd </span><span class="pln">/usr/local/spark/mycode/streaming/</span></li><li class="L1"><span class="pln">ls</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>可以看到目录下有NetworkWordCountStateful.py文件<br>
其中，NetworkWordCountStateful.py的代码如下：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">from</span><span class="pln"> __future__ </span><span class="kwd">import</span><span class="pln"> print_function</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">import</span><span class="pln"> sys</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">from</span><span class="pln"> pyspark </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">SparkContext</span></li><li class="L5"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">streaming </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">StreamingContext</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">if</span><span class="pln"> __name__ </span><span class="pun">==</span><span class="pln"> </span><span class="str">"__main__"</span><span class="pun">:</span></li><li class="L8"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">3</span><span class="pun">:</span></li><li class="L9"><span class="pln">        </span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Usage: stateful_network_wordcount.py &lt;hostname&gt; &lt;port&gt;"</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">=</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">stderr</span><span class="pun">)</span></li><li class="L0"><span class="pln">        exit</span><span class="pun">(-</span><span class="lit">1</span><span class="pun">)</span></li><li class="L1"><span class="pln">    sc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">SparkContext</span><span class="pun">(</span><span class="pln">appName</span><span class="pun">=</span><span class="str">"PythonStreamingStatefulNetworkWordCount"</span><span class="pun">)</span></li><li class="L2"><span class="pln">    ssc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">StreamingContext</span><span class="pun">(</span><span class="pln">sc</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></li><li class="L3"><span class="pln">    ssc</span><span class="pun">.</span><span class="pln">checkpoint</span><span class="pun">(</span><span class="str">"file:///usr/local/spark/mycode/streaming/"</span><span class="pun">)</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="com"># RDD with initial state (key, value) pairs</span></li><li class="L6"><span class="pln">    initialStateRDD </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">parallelize</span><span class="pun">([(</span><span class="pln">u</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'world'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)])</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> updateFunc</span><span class="pun">(</span><span class="pln">new_values</span><span class="pun">,</span><span class="pln"> last_sum</span><span class="pun">):</span></li><li class="L9"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> sum</span><span class="pun">(</span><span class="pln">new_values</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">last_sum </span><span class="kwd">or</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">    lines </span><span class="pun">=</span><span class="pln"> ssc</span><span class="pun">.</span><span class="pln">socketTextStream</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]))</span></li><li class="L2"><span class="pln">    running_counts </span><span class="pun">=</span><span class="pln"> lines</span><span class="pun">.</span><span class="pln">flatMap</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> line</span><span class="pun">:</span><span class="pln"> line</span><span class="pun">.</span><span class="pln">split</span><span class="pun">(</span><span class="str">" "</span><span class="pun">))</span><span class="pln">\</span></li><li class="L3"><span class="pln">                          </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> word</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">word</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span><span class="pln">\</span></li><li class="L4"><span class="pln">                          </span><span class="pun">.</span><span class="pln">updateStateByKey</span><span class="pun">(</span><span class="pln">updateFunc</span><span class="pun">,</span><span class="pln"> initialRDD</span><span class="pun">=</span><span class="pln">initialStateRDD</span><span class="pun">)</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">    running_counts</span><span class="pun">.</span><span class="pln">pprint</span><span class="pun">()</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    ssc</span><span class="pun">.</span><span class="pln">start</span><span class="pun">()</span></li><li class="L9"><span class="pln">    ssc</span><span class="pun">.</span><span class="pln">awaitTermination</span><span class="pun">()</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">&nbsp;</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>运行此程序，执行如下代码：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">python3 NetworkWordCountStateful.py localhost 9999</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>启动后屏幕上就会显示类似下面的程序运行信息：</p>
<pre><code>-------------------------------------------
Time: 1479890485000 ms
-------------------------------------------

-------------------------------------------
Time: 1479890490000 ms
-------------------------------------------
</code></pre>
<p>下面，请打开另外一个终端，作为单词产生的源头，提供给NetworkWordCountStateful程序进行词频统计：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">nc -lk 9999</span></li><li class="L1"><span class="pln">//请手动输入一些单词，可以随便输入，输入一个单词就敲入回车，比如下面是笔者输入的单词</span></li><li class="L2"><span class="pln">hadoop</span></li><li class="L3"><span class="pln">spark</span></li><li class="L4"><span class="pln">hadoop</span></li><li class="L5"><span class="pln">spark</span></li><li class="L6"><span class="pln">hadoop</span></li><li class="L7"><span class="pln">spark</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>这个时候，你再去看刚才运行NetworkWordCountStateful程序的监听窗口，就可以看到类似下面的词频统计结果：</p>
<pre><code>-------------------------------------------
Time: 1479890485000 ms
-------------------------------------------
(spark,1)
(hadoop,1)

-------------------------------------------
Time: 1479890490000 ms
-------------------------------------------
(spark,2)
(hadoop,3)
</code></pre>
<p>现在可以结束程序运行了，可以按Ctrl+Z结束当前程序的运行。<br>
好了，以前的知识复习结束。现在，请把刚才打开的这两个终端窗口都关闭掉。有了这个基础，我们就可以顺利开展本节内容的学习了，也就是如何把DStream输出到外部系统中。</p>
<h1>把DStream输出到文本文件中</h1>
<p>下面请新打开一个终端。为了不破坏以前的代码，我们单独复制上面这些代码到新的文件中，执行如下代码</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">cp </span><span class="pln">./NetworkWordCountStateful.py ./DstreamToText.py</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>首先，我们尝试把DStream内容保存到文本文件中，可以使用如下语句：</p>
<p>running_counts.saveAsTextFiles(“file:///usr/local/spark/mycode/streaming/output.txt”)<br>
下面使用vim编辑器打开DstreamToText.py代码文件：</p>
<pre><code>vim ./DstreamToText.py
</code></pre>
<p>我们要把这条保存数据的语句stateDstream.saveAsTextFiles()放入到DstreamToText.py代码中，修改后
的代码如下（或者你可以把NetworkWordCountStateful.scala原来的代码内容全部删除，直接把下面修改后的代码复制进去）：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">from __future__ import print_function</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">import sys</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">from pyspark import SparkContext</span></li><li class="L5"><span class="pln">from pyspark.streaming import StreamingContext</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">if __name__ == </span><span class="str">"__main__"</span><span class="pln">:</span></li><li class="L8"><span class="pln">    if len(sys.argv) != 3:</span></li><li class="L9"><span class="pln">        print(</span><span class="str">"Usage: stateful_network_wordcount.py &lt;hostname&gt; &lt;port&gt;"</span><span class="pln">, file=sys.stderr)</span></li><li class="L0"><span class="pln">        exit(-1)</span></li><li class="L1"><span class="pln">    sc = SparkContext(appName=</span><span class="str">"PythonStreamingStatefulNetworkWordCount"</span><span class="pln">)</span></li><li class="L2"><span class="pln">    ssc = StreamingContext(sc, 5)</span></li><li class="L3"><span class="pln">    ssc.checkpoint(</span><span class="str">"file:///usr/local/spark/mycode/streaming/"</span><span class="pln">)</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="com"># RDD with initial state (key, value) pairs</span></li><li class="L6"><span class="pln">    initialStateRDD = sc.parallelize([(u</span><span class="str">'hello'</span><span class="pln">, 1), (u</span><span class="str">'world'</span><span class="pln">, 1)])</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    def updateFunc(new_values, last_sum):</span></li><li class="L9"><span class="pln">        return sum(new_values) + (last_sum or 0)</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">    lines = ssc.socketTextStream(sys.argv[1], int(sys.argv[2]))</span></li><li class="L2"><span class="pln">    running_counts = lines.flatMap(lambda line: line.split(</span><span class="str">" "</span><span class="pln">)) .map(lambda word: (word, 1)).updateStateByKey(updateFunc, initialRDD=initialStateRD)</span></li><li class="L3"><span class="pln">        running_counts.saveAsTextFiles(</span><span class="str">"file:///usr/local/spark/mycode/streaming/output.txt"</span><span class="pln">)</span></li><li class="L4"><span class="pln">    running_counts.pprint()</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">    ssc.start()</span></li><li class="L7"><span class="pln">    ssc.awaitTermination()</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">&nbsp;</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>运行此程序，执行如下命令：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">python3 ./DstreamToText.py localhost 9999</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>程序运行以后，屏幕上就会显示类似下面的程序运行信息：</p>
<pre><code>-------------------------------------------
Time: 1479890485000 ms
-------------------------------------------

-------------------------------------------
Time: 1479890490000 ms
-------------------------------------------
</code></pre>
<p>下面，请打开另外一个终端，作为单词产生的源头，提供给NetworkWordCountStateful程序进行词频统计：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">nc -lk 9999</span></li><li class="L1"><span class="pln">//请手动输入一些单词，可以随便输入，比如下面是笔者输入的单词</span></li><li class="L2"><span class="pln">hadoop</span></li><li class="L3"><span class="pln">spark</span></li><li class="L4"><span class="pln">hadoop</span></li><li class="L5"><span class="pln">spark</span></li><li class="L6"><span class="pln">hadoop</span></li><li class="L7"><span class="pln">spark</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>这个时候，你再去看刚才运行NetworkWordCountStateful程序的监听窗口，就可以看到类似下面的词频统计结果：</p>
<pre><code>-------------------------------------------
Time: 1479890485000 ms
-------------------------------------------
(spark,1)
(hadoop,1)

-------------------------------------------
Time: 1479890490000 ms
-------------------------------------------
(spark,2)
(hadoop,3)
</code></pre>
<p>然后，我们停止程序运行，在当前终端内按键盘Ctrlz+Z组合键，就可以结束程序运行。现在我们就看一下，这些词频结果是否被成功地输出到“/usr/local/spark/mycode/streaming/output.txt”文件中了。请执行如下命令：</p>
<pre><code>cd /usr/local/spark/mycode/streaming/
ls
</code></pre>
<p>可以发现，在这个目录下，生成了很多文本文件，如下：</p>
<pre><code>output.txt-1479951955000
output.txt-1479951960000
output.txt-1479951965000
output.txt-1479951970000
output.txt-1479951975000
output.txt-1479951980000
output.txt-1479951985000
</code></pre>
<p>可以看出，由于我们在代码中有一句” ssc = StreamingContext(sc, 
5)”，也就是说，每隔5秒钟统计一次词频，所以，每隔5秒钟就会生成一次词频统计结果，并输出到“/usr/local/spark/mycode
/streaming/output.txt”中，每次生成的output.txt后面会自动被加上时间标记（比如1479951955000）。这里要
注意，虽然我们把DStream输出到“/usr/local/spark/mycode/streaming/output.txt”
中，output.txt的命名看起来像一个文件，但是，实际上，spark会生成名称为output.txt的目录，而不是文件。这个问题，我们在之前
“文件数据读写”章节的学习中已经讨论过，这里不再赘述。<br>
我们可以查看一下某个output.txt下面的内容：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln"> </span><span class="kwd">cat </span><span class="pln">output.txt-1479951980000/*</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>会得到类似下面的结果：</p>
<pre><code>(hello,1)
(spark,2)
(hadoop,2)
</code></pre>
<p>说明我们已经成功地把DStream输出到文本文件了。</p>
<h1>把DStream写入到MySQL数据库中</h1>
<p>请执行下面命令在Linux中启动MySQL数据库，并完成数据库和表的创建：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">service mysql start</span></li><li class="L1"><span class="pln">mysql -u root -p</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>输入密码后，你就可以进入“mysql&gt;”命令提示符状态，然后就可以输入下面的SQL语句完成数据库和表的创建。在我们之前“<a href="http://dblab.xmu.edu.cn/blog/1724-2/" target="_blank">通过JDBC连接数据库(DataFrame)</a>”章节的内容中，我们已经在MySQL数据库中创建了一个名称为“spark”的数据库和名称为“student”的表。这里，我们可以直接使用这个已经创建好的“spark”数据库，然后，在这个数据库中创建一个名称为“wordcount”的表，命令如下：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-mysql prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">mysql</span><span class="pun">&gt;</span><span class="pln"> </span><span class="kwd">use</span><span class="pln"> spark</span></li><li class="L1"><span class="pln">mysql</span><span class="pun">&gt;</span><span class="pln"> create table wordcount </span><span class="pun">(</span><span class="pln">word </span><span class="kwd">char</span><span class="pun">(</span><span class="lit">20</span><span class="pun">),</span><span class="pln"> count </span><span class="kwd">int</span><span class="pun">(</span><span class="lit">4</span><span class="pun">));</span></li><li class="L2"><span class="pln">mysql</span><span class="pun">&gt;</span><span class="pln"> </span><span class="kwd">select</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="kwd">from</span><span class="pln"> wordcount</span></li><li class="L3"><span class="com">//这个时候wordcount表是空的，没有任何记录</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">mysql</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>由于需要python连接到mysql的模块，所以请执行如下命令：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">sudo </span><span class="pln">pip3 install PyMySQL</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>下面，请新打开另外一个Linux终端，我们就可以对NetworkWordCountStateful.py代码文件进行修改，为了方便起见，你可以直接执行下面命令删除该文件，再用vim编辑器新建该文件：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">cd </span><span class="pln">/usr/local/spark/mycode/streaming/</span></li><li class="L1"><span class="kwd">rm </span><span class="pln">NetworkWordCountStateful.py</span></li><li class="L2"><span class="kwd">vim </span><span class="pln">NetworkWordCountStateful.py</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>然后，在NetworkWordCountStateful.py文件中加入下面代码：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">from</span><span class="pln"> __future__ </span><span class="kwd">import</span><span class="pln"> print_function</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">import</span><span class="pln"> sys</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">import</span><span class="pln"> pymysql</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">from</span><span class="pln"> pyspark </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">SparkContext</span></li><li class="L7"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">streaming </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">StreamingContext</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">if</span><span class="pln"> __name__ </span><span class="pun">==</span><span class="pln"> </span><span class="str">"__main__"</span><span class="pun">:</span></li><li class="L0"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">3</span><span class="pun">:</span></li><li class="L1"><span class="pln">        </span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Usage: stateful_network_wordcount.py &lt;hostname&gt; &lt;port&gt;"</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">=</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">stderr</span><span class="pun">)</span></li><li class="L2"><span class="pln">        exit</span><span class="pun">(-</span><span class="lit">1</span><span class="pun">)</span></li><li class="L3"><span class="pln">    sc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">SparkContext</span><span class="pun">(</span><span class="pln">appName</span><span class="pun">=</span><span class="str">"PythonStreamingStatefulNetworkWordCount"</span><span class="pun">)</span></li><li class="L4"><span class="pln">    ssc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">StreamingContext</span><span class="pun">(</span><span class="pln">sc</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></li><li class="L5"><span class="pln">    ssc</span><span class="pun">.</span><span class="pln">checkpoint</span><span class="pun">(</span><span class="str">"file:///usr/local/spark/mycode/streaming/"</span><span class="pun">)</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">    </span><span class="com"># RDD with initial state (key, value) pairs</span></li><li class="L8"><span class="pln">    initialStateRDD </span><span class="pun">=</span><span class="pln"> sc</span><span class="pun">.</span><span class="pln">parallelize</span><span class="pun">([(</span><span class="pln">u</span><span class="str">'hello'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">),</span><span class="pln"> </span><span class="pun">(</span><span class="pln">u</span><span class="str">'world'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)])</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> updateFunc</span><span class="pun">(</span><span class="pln">new_values</span><span class="pun">,</span><span class="pln"> last_sum</span><span class="pun">):</span></li><li class="L1"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> sum</span><span class="pun">(</span><span class="pln">new_values</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">last_sum </span><span class="kwd">or</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">    lines </span><span class="pun">=</span><span class="pln"> ssc</span><span class="pun">.</span><span class="pln">socketTextStream</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]))</span></li><li class="L4"><span class="pln">    running_counts </span><span class="pun">=</span><span class="pln"> lines</span><span class="pun">.</span><span class="pln">flatMap</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> line</span><span class="pun">:</span><span class="pln"> line</span><span class="pun">.</span><span class="pln">split</span><span class="pun">(</span><span class="str">" "</span><span class="pun">))</span><span class="pln">\</span></li><li class="L5"><span class="pln">                          </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> word</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">word</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span><span class="pln">\</span></li><li class="L6"><span class="pln">                          </span><span class="pun">.</span><span class="pln">updateStateByKey</span><span class="pun">(</span><span class="pln">updateFunc</span><span class="pun">,</span><span class="pln"> initialRDD</span><span class="pun">=</span><span class="pln">initialStateRDD</span><span class="pun">)</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    running_counts</span><span class="pun">.</span><span class="pln">pprint</span><span class="pun">()</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> dbfunc</span><span class="pun">(</span><span class="pln">records</span><span class="pun">):</span></li><li class="L1"><span class="pln">        db </span><span class="pun">=</span><span class="pln"> pymysql</span><span class="pun">.</span><span class="pln">connect</span><span class="pun">(</span><span class="str">"localhost"</span><span class="pun">,</span><span class="str">"root"</span><span class="pun">,</span><span class="str">"root"</span><span class="pun">,</span><span class="str">"spark"</span><span class="pun">)</span></li><li class="L2"><span class="pln">        cursor </span><span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">cursor</span><span class="pun">()</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">        </span><span class="kwd">def</span><span class="pln"> doinsert</span><span class="pun">(</span><span class="pln">p</span><span class="pun">):</span></li><li class="L5"><span class="pln">            sql </span><span class="pun">=</span><span class="pln"> </span><span class="str">"insert into wordcount(word,count) values ('%s', '%s')"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">str</span><span class="pun">(</span><span class="pln">p</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]),</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">p</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]))</span></li><li class="L6"><span class="pln">            </span><span class="kwd">try</span><span class="pun">:</span></li><li class="L7"><span class="pln">                cursor</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">(</span><span class="pln">sql</span><span class="pun">)</span><span class="pln">                </span></li><li class="L8"><span class="pln">                db</span><span class="pun">.</span><span class="pln">commit</span><span class="pun">()</span></li><li class="L9"><span class="pln">            </span><span class="kwd">except</span><span class="pun">:</span><span class="pln">                    </span></li><li class="L0"><span class="pln">                db</span><span class="pun">.</span><span class="pln">rollback</span><span class="pun">()</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">        </span><span class="kwd">for</span><span class="pln"> item </span><span class="kwd">in</span><span class="pln"> records</span><span class="pun">:</span></li><li class="L3"><span class="pln">            doinsert</span><span class="pun">(</span><span class="pln">item</span><span class="pun">)</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> func</span><span class="pun">(</span><span class="pln">rdd</span><span class="pun">):</span></li><li class="L6"><span class="pln">        repartitionedRDD </span><span class="pun">=</span><span class="pln"> rdd</span><span class="pun">.</span><span class="pln">repartition</span><span class="pun">(</span><span class="lit">3</span><span class="pun">)</span></li><li class="L7"><span class="pln">        repartitionedRDD</span><span class="pun">.</span><span class="pln">foreachPartition</span><span class="pun">(</span><span class="pln">dbfunc</span><span class="pun">)</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">    running_counts</span><span class="pun">.</span><span class="pln">foreachRDD</span><span class="pun">(</span><span class="pln">func</span><span class="pun">)</span></li><li class="L0"><span class="pln">    ssc</span><span class="pun">.</span><span class="pln">start</span><span class="pun">()</span></li><li class="L1"><span class="pln">    ssc</span><span class="pun">.</span><span class="pln">awaitTermination</span><span class="pun">()</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>保存该文件，退出vim编辑器。这个代码的具体含义，我们过一会儿再解释，现在我们先执行一下程序，看看效果。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">python3 ./NetworkWordCountStateful.py localhost 9999</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>执行上面命令以后，就进入监听状态，下面我们打开另外一个终端，运行下面命令产生单词提供给NetworkWordCountStateful进行词频统计：</p>
<pre><code>nc -lk 9999
//现在你就可以在当前窗口内随意输入单词，输入一个单词就回车，比如输入下面单词
hello
hadoop
spark
hello
spark
</code></pre>
<p>输入一些单词以后，就可以按Ctrl+Z停止nc程序。然后切换到刚才运行NetworkWordCountStateful程序的监听窗口，也按
Ctrl+Z停止NetworkWordCountStateful程序运行。然后，再切换到刚才运行MySQL的终端窗口，在mysql命令提示符下输
入查看命令，就可以查看spark.wordcount表内当前最新的数据：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-mysql prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">mysql</span><span class="pun">&gt;</span><span class="pln"> </span><span class="kwd">select</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="kwd">from</span><span class="pln"> wordcount</span><span class="pun">;</span></li><li class="L1"><span class="pun">+--------+-------+</span></li><li class="L2"><span class="pun">|</span><span class="pln"> word   </span><span class="pun">|</span><span class="pln"> count </span><span class="pun">|</span></li><li class="L3"><span class="pun">+--------+-------+</span></li><li class="L4"><span class="pun">|</span><span class="pln"> hello  </span><span class="pun">|</span><span class="pln">     </span><span class="lit">1</span><span class="pln"> </span><span class="pun">|</span></li><li class="L5"><span class="pun">|</span><span class="pln"> hadoop </span><span class="pun">|</span><span class="pln">     </span><span class="lit">1</span><span class="pln"> </span><span class="pun">|</span></li><li class="L6"><span class="pun">|</span><span class="pln"> hello  </span><span class="pun">|</span><span class="pln">     </span><span class="lit">2</span><span class="pln"> </span><span class="pun">|</span></li><li class="L7"><span class="pun">|</span><span class="pln"> spark  </span><span class="pun">|</span><span class="pln">     </span><span class="lit">1</span><span class="pln"> </span><span class="pun">|</span></li><li class="L8"><span class="pun">|</span><span class="pln"> hadoop </span><span class="pun">|</span><span class="pln">     </span><span class="lit">2</span><span class="pln"> </span><span class="pun">|</span></li><li class="L9"><span class="pun">|</span><span class="pln"> hello  </span><span class="pun">|</span><span class="pln">     </span><span class="lit">2</span><span class="pln"> </span><span class="pun">|</span></li><li class="L0"><span class="pun">|</span><span class="pln"> spark  </span><span class="pun">|</span><span class="pln">     </span><span class="lit">3</span><span class="pln"> </span><span class="pun">|</span></li><li class="L1"><span class="pun">|</span><span class="pln"> hadoop </span><span class="pun">|</span><span class="pln">     </span><span class="lit">2</span><span class="pln"> </span><span class="pun">|</span></li><li class="L2"><span class="pun">+--------+-------+</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">mysql</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>我们重点来分析其中的这段代码（其他代码之前我们都已经介绍过含义）：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln"> </span><span class="kwd">def</span><span class="pln"> dbfunc</span><span class="pun">(</span><span class="pln">records</span><span class="pun">):</span></li><li class="L1"><span class="pln">        db </span><span class="pun">=</span><span class="pln"> pymysql</span><span class="pun">.</span><span class="pln">connect</span><span class="pun">(</span><span class="str">"localhost"</span><span class="pun">,</span><span class="str">"root"</span><span class="pun">,</span><span class="str">"root"</span><span class="pun">,</span><span class="str">"spark"</span><span class="pun">)</span></li><li class="L2"><span class="pln">        cursor </span><span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">cursor</span><span class="pun">()</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">        </span><span class="kwd">def</span><span class="pln"> doinsert</span><span class="pun">(</span><span class="pln">p</span><span class="pun">):</span></li><li class="L5"><span class="pln">            sql </span><span class="pun">=</span><span class="pln"> </span><span class="str">"insert into wordcount(word,count) values ('%s', '%s')"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">str</span><span class="pun">(</span><span class="pln">p</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]),</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">p</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]))</span></li><li class="L6"><span class="pln">            </span><span class="kwd">try</span><span class="pun">:</span></li><li class="L7"><span class="pln">                cursor</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">(</span><span class="pln">sql</span><span class="pun">)</span><span class="pln">                </span></li><li class="L8"><span class="pln">                db</span><span class="pun">.</span><span class="pln">commit</span><span class="pun">()</span></li><li class="L9"><span class="pln">            </span><span class="kwd">except</span><span class="pun">:</span><span class="pln">                    </span></li><li class="L0"><span class="pln">                db</span><span class="pun">.</span><span class="pln">rollback</span><span class="pun">()</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">        </span><span class="kwd">for</span><span class="pln"> item </span><span class="kwd">in</span><span class="pln"> records</span><span class="pun">:</span></li><li class="L3"><span class="pln">            doinsert</span><span class="pun">(</span><span class="pln">item</span><span class="pun">)</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="kwd">def</span><span class="pln"> func</span><span class="pun">(</span><span class="pln">rdd</span><span class="pun">):</span></li><li class="L6"><span class="pln">        repartitionedRDD </span><span class="pun">=</span><span class="pln"> rdd</span><span class="pun">.</span><span class="pln">repartition</span><span class="pun">(</span><span class="lit">3</span><span class="pun">)</span></li><li class="L7"><span class="pln">        repartitionedRDD</span><span class="pun">.</span><span class="pln">foreachPartition</span><span class="pun">(</span><span class="pln">dbfunc</span><span class="pun">)</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">    running_counts</span><span class="pun">.</span><span class="pln">foreachRDD</span><span class="pun">(</span><span class="pln">func</span><span class="pun">)</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>也就是说，对于running_counts，为了把它保存到MySQL数据库中，我们采用了如下的形式：</p>
<pre><code>running_counts.foreachRDD(func)
</code></pre>
<p>其中，func就是一个RDD[T]=&gt;Unit类型的函数，对于本程序而言，就是RDD[(String,Int)] : 
Unit类型的函数，也就是说，stateDstream中的每个RDD都是RDD[(String,Int)]类型（想象一下，统计结果的形式是
(“hadoop”,3)）。这样，对stateDstream中的每个RDD都会执行function中的操作（即把该RDD保存到MySQL的操
作）。</p>
<p>下面看function的处理逻辑，在function部分，函数体要执行的处理逻辑实际上是下面的形式：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">val repartitionedRDD </span><span class="pun">=</span><span class="pln"> rdd</span><span class="pun">.</span><span class="pln">repartition</span><span class="pun">(</span><span class="lit">3</span><span class="pun">)</span></li><li class="L1"><span class="pln">repartitionedRDD</span><span class="pun">.</span><span class="pln">foreachPartition</span><span class="pun">(</span><span class="pln">dbfunc</span><span class="pun">)</span><span class="pln"> </span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>也就是说，这里定义了一个内部函数dbfunc，它的功能是，接收records，然后把records保存到MySQL中。到这里，你可能会有疑
问？为什么不是把stateDstream中的每个RDD直接拿去保存到MySQL中，还要调用rdd.repartition(3)对这些RDD重新设
置分区数为3呢？这是因为，每次保存RDD到MySQL中，都需要启动数据库连接，如果RDD分区数量太大，那么就会带来多次数据库连接开销，为了减少开
销，就有必要把RDD的分区数量控制在较小的范围内，所以，这里就把RDD的分区数量重新设置为3。然后，对于每个RDD分区，就调用
repartitionedRDD.foreachPartition(dbfunc)，把每个分区的数据通过dbfunc保存到MySQL中，这时，传
递给dbfunc的输入参数就是Iterator[(String,Int)]类型的records。如果你不好理解下面这种调用形式：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">repartitionedRDD</span><span class="pun">.</span><span class="pln">foreachPartition</span><span class="pun">(</span><span class="pln">dbfunc</span><span class="pun">)</span><span class="pln"> </span></li><li class="L1"><span class="com"># 这种形式func没有带任何参数，可能不太好理解，不是那么直观</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>实际上，这句语句和下面的语句是等价的，下面的语句形式你可能会更好理解：</p>
<pre><code>repartitionedRDD.foreachPartition(lambda records :  dbfunc(records)) 
</code></pre>
<p>上面这种等价的形式比较直观，为func()函数传入了一个records参数，这就正好和 def func(records: Iterator[(String,Int)])定义对应起来了，方便理解。</p>
			</div><!-- .entry-content -->

	<footer class="entry-footer">
		<div class="entry-author">
			<div class="author-title">本文作者</div>
			
		<div class="author-avatar"><img src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/2.jpg" alt="阮榕城" class="avatar avatar-thumbnail wp-user-avatar wp-user-avatar-thumbnail alignnone photo"></div>
		<div class="author-info">
			<p class="author-name"><a href="http://dblab.xmu.edu.cn/blog/author/ruanrongcheng/">阮榕城</a></p>
			<p class="author-desc">磨人的小妖精！</p>
			<p class="author-contact"><a href="http://www.nekomiao.me/" target="_blank" title="个人主页" class="homepage"><i class="fa fa-home"></i>www.nekomiao.me</a><i class="fa fa-envelope"></i><span class="envelope">moc.qq@crnaur</span></p>
		</div>
			</div>
		<div class="entry-info">
			<span class="permalink"><i class="fa fa-external-link"></i> <a href="http://dblab.xmu.edu.cn/blog/1749-2/" title="Spark入门：DStream输出操作(Python版)">http://dblab.xmu.edu.cn/blog/1749-2/</a></span><span class="category"><i class="fa fa-folder-open-o"></i> <a href="http://dblab.xmu.edu.cn/blog/category/big-data/" rel="category tag">大数据</a></span>		</div>
		<div class="yarpp-related yarpp-related-none">
</div>
	</footer><!-- .entry-footer -->
</article><!-- #post-## -->
			</div>
</div><!-- .row -->

	<div class="row">
		<div class="col-sm-3"></div>
		<div class="col-sm-9 site-footer">
			© 2014 <a href="http://dblab.xmu.edu.cn/">厦大数据库实验室</a>
					</div>
	</div>
</div><!-- .container -->
<link rel="stylesheet" id="yarppRelatedCss-css" href="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/related.css" type="text/css" media="all">
<script type="text/javascript" src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/prettify.js"></script>
<script type="text/javascript" src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/power.js"></script>
<script type="text/javascript" src="5.10Spark%E5%85%A5%E9%97%A8%EF%BC%9ADStream%E8%BE%93%E5%87%BA%E6%93%8D%E4%BD%9C(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/wp-embed.js"></script>

<div class="back-to-top" id="back-to-top" title="嗖的就上去了！" style="display: block;"><span><i class="fa fa-chevron-up"></i></span></div></body></html>