<!DOCTYPE html>
<html lang="zh-CN"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spark2.1.0入门：模型选择和超参数调整(Python版)_厦大数据库实验室博客</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<link rel="dns-prefetch" href="http://cdn.staticfile.org/">
<link rel="dns-prefetch" href="http://s.w.org/">
<link rel="stylesheet" id="yarppWidgetCss-css" href="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/widget.css" type="text/css" media="all">
<link rel="stylesheet" id="wp-quicklatex-format-css" href="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/quicklatex-format.css" type="text/css" media="all">
<link rel="stylesheet" id="bootstrap-css" href="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/bootstrap.css" type="text/css" media="all">
<link rel="stylesheet" id="font-awesome-css" href="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/font-awesome.css" type="text/css" media="all">
<link rel="stylesheet" id="power-css" href="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/style.css" type="text/css" media="all">
<link rel="stylesheet" id="google-code-prettify-css" href="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/prettify.css" type="text/css" media="all">
<script type="text/javascript" async="" charset="utf-8" src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/core.js"></script><script src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/hm.js"></script><script src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/z_stat.js"></script><script type="text/javascript" src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/jquery_002.js"></script>
<script type="text/javascript" src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/jquery.js"></script>
<script type="text/javascript" src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/jquery-migrate.js"></script>
<script type="text/javascript" src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/wp-quicklatex-frontend.js"></script>
<link rel="https://api.w.org/" href="http://dblab.xmu.edu.cn/blog/wp-json/">
<link rel="prev" title="Spark 2.1.0 入门：协同过滤算法(Python版)" href="http://dblab.xmu.edu.cn/blog/1781-2/">
<link rel="next" title="Python：继承" href="http://dblab.xmu.edu.cn/blog/1786-2/">
<link rel="canonical" href="http://dblab.xmu.edu.cn/blog/1782-2/">
<link rel="alternate" type="application/json+oembed" href="http://dblab.xmu.edu.cn/blog/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fdblab.xmu.edu.cn%2Fblog%2F1782-2%2F">
<!--[if lt IE 9]>
<script src="http://dblab.xmu.edu.cn/blog/wp-content/themes/power/js/html5shiv.js"></script>
<![endif]-->
</head>

<body class="post-template-default single single-post postid-1782 single-format-standard group-blog">
<div class="container site-page">

<div class="row">
	<div class="col-sm-3 site-infos">
		<h4 class="site-title">
			<a href="http://dblab.xmu.edu.cn/blog/" title="厦大数据库实验室博客" rel="home">厦大数据库实验室博客</a>
		</h4>
		<div class="site-description">总结、分享、收获<p><a href="http://dblab.xmu.edu.cn/" title="厦大数据库实验室">实验室主页</a></p></div>

		<nav class="main-navigation" role="navigation">
			<div class="menu-primary-container"><ul id="menu-primary" class="menu menu-level-1"><li id="menu-item-80" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/">首页</a></li>
<li id="menu-item-85" class="menu-item item-level-1 current-path"><a href="http://dblab.xmu.edu.cn/blog/category/big-data/">大数据</a></li>
<li id="menu-item-676" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/category/databases/">数据库</a></li>
<li id="menu-item-87" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/category/data-mining/">数据挖掘</a></li>
<li id="menu-item-86" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/category/others/">其他</a></li>
</ul></div>		</nav><!-- #site-navigation -->

		<div class="search"><form role="search" method="get" class="search-form" action="http://dblab.xmu.edu.cn/blog/">
				<label>
					<span class="screen-reader-text">搜索：</span>
					<input class="search-field" placeholder="搜索…" name="s" type="search">
				</label>
				<input class="search-submit" value="搜索" type="submit">
			</form></div>
	</div>
	<div class="col-sm-9 site-main">

					<article id="post-1782" class="post-1782 post type-post status-publish format-standard hentry category-big-data">
	<header class="entry-header">
		<h1 class="entry-title">Spark2.1.0入门：模型选择和超参数调整(Python版)</h1>

		<div class="entry-meta">
			<span class="author"><i class="fa fa-user"></i> 阮榕城</span><span class="date"><i class="fa fa-calendar"></i> <time datetime="2017-12-19T11:00:57+00:00">2017年12月19日</time></span><span class="views" id="views"><i class="fa fa-eye"></i> 2099</span>		</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

	<div class="entry-content">
		<div class="bigdata-book">
			<a href="http://dblab.xmu.edu.cn/post/5899/" title="2019年1月20日寒假大数据师资培训班" target="_blank"><img src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/peixunban2019-01-20.jpg" alt="2019年1月20日寒假大数据师资培训班"></a>
		</div>
		<p>【版权声明】博客内容由厦门大学数据库实验室拥有版权，未经允许，请勿转载！<br>
<a href="http://dblab.xmu.edu.cn/blog/1709-2/" target="_blank">返回Spark教程首页</a><br>
<span id="more-1782"></span></p>
<h1>模型选择和超参数调整</h1>
<p>在机器学习中非常重要的任务就是模型选择，或者使用数据来找到具体问题的最佳的模型和参数，这个过程也叫做调试（Tuning）。调试可以在独立的
估计器中完成（如逻辑斯蒂回归），也可以在包含多样算法、特征工程和其他步骤的工作流中完成。用户应该一次性调优整个工作流，而不是独立的调整
PipeLine中的每个组成部分。</p>
<h2>1、 交叉验证和训练-验证切分</h2>
<pre><code>MLlib支持交叉验证（CrossValidator）和训练验证分割（TrainValidationSplit）两个模型选择工具。使用这些工具要求包含如下对象：
</code></pre>
<p>1.估计器：待调试的算法或管线。</p>
<p>2.一系列参数表（ParamMaps）：可选参数，也叫做“参数网格”搜索空间。</p>
<p>3.评估器：评估模型拟合程度的准则或方法。</p>
<p>模型选择工具工作原理如下：</p>
<p>1.将输入数据划分为训练数据和测试数据。</p>
<ol>
<li>对于每个（训练，测试）对，遍历一组ParamMaps。用每一个ParamMap参数来拟合估计器，得到训练后的模型，再使用评估器来评估模型表现。</li>
</ol>
<p>3.选择性能表现最优模型对应参数表。</p>
<p>更具体的，交叉验证CrossValidato将数据集切分成k折叠数据集合，并被分别用于训练和测试。例如，k=3
时，CrossValidator会生成3个（训练数据，测试数据）对，每一个数据对的训练数据占2/3，测试数据占1/3。为了评估一个
ParamMap，CrossValidator 
会计算这3个不同的（训练，测试）数据集对在Estimator拟合出的模型上的平均评估指标。在找出最好的ParamMap
后，CrossValidator 
会使用这个ParamMap和整个的数据集来重新拟合Estimator。也就是说通过交叉验证找到最佳的ParamMap，利用此ParamMap在整
个训练集上可以训练（fit）出一个泛化能力强，误差相对小的的最佳模型。</p>
<p>交叉验证的代价比较高昂，为此Spark也为超参数调优提供了训练-验证切分TrainValidationSplit。
TrainValidationSplit创建单一的（训练，测试）数据集对。它使用trainRatio参数将数据集切分成两部分。例如，当设置
trainRatio=0.75时，TrainValidationSplit将会将数据切分75%作为数据集，25%作为验证集，来生成训练、测试集
对，并最终使用最好的ParamMap和完整的数据集来拟合评估器。相对于CrossValidator对每一个参数进行k次评
估，TrainValidationSplit只对每个参数组合评估1次。因此它的评估代价没有这么高，但是当训练数据集不够大的时候其结果相对不够可
信。</p>
<h2>2、 使用交叉验证进行模型选择</h2>
<p>使用CrossValidator的代价可能会异常的高。然而，对比启发式的手动调优，这是选择参数的行之有效的方法。下面示例示范了使用CrossValidator从整个网格的参数中选择合适的参数。</p>
<p>首先，导入必要的包：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">ml</span><span class="pun">.</span><span class="pln">linalg </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Vector</span><span class="pun">,</span><span class="typ">Vectors</span></li><li class="L1"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">ml</span><span class="pun">.</span><span class="pln">feature </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">HashingTF</span><span class="pun">,</span><span class="typ">Tokenizer</span></li><li class="L2"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">ml</span><span class="pun">.</span><span class="pln">tuning </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">CrossValidator</span><span class="pun">,</span><span class="pln"> </span><span class="typ">ParamGridBuilder</span></li><li class="L3"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">sql </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Row</span></li><li class="L4"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">ml</span><span class="pun">.</span><span class="pln">evaluation </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">MulticlassClassificationEvaluator</span></li><li class="L5"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">ml</span><span class="pun">.</span><span class="pln">feature </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">IndexToString</span><span class="pun">,</span><span class="pln"> </span><span class="typ">StringIndexer</span><span class="pun">,</span><span class="pln"> </span><span class="typ">VectorIndexer</span></li><li class="L6"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">ml</span><span class="pun">.</span><span class="pln">classification </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">LogisticRegression</span><span class="pun">,</span><span class="typ">LogisticRegressionModel</span></li><li class="L7"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">ml </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Pipeline</span><span class="pun">,</span><span class="pln"> </span><span class="typ">PipelineModel</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>接下来，读取Irisi数据集，分别获取标签列和特征列，进行索引、重命名，并设置机器学习工作流。交叉验证在把原始数据集分割为训练集与测试集。
值得注意的是，只有训练集才可以用在模型的训练过程中，测试集则必须在模型完成之后才被用来评估模型优劣的依据。此外，训练集中样本数量必须够多，一般至
少大于总样本数的 50%，且两组子集必须从完整集合中均匀取样。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">def</span><span class="pln"> f</span><span class="pun">(</span><span class="pln">x</span><span class="pun">):</span></li><li class="L1"><span class="pln">    rel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{}</span></li><li class="L2"><span class="pln">    rel</span><span class="pun">[</span><span class="str">'features'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Vectors</span><span class="pun">.</span><span class="pln">dense</span><span class="pun">(</span><span class="pln">float</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]),</span><span class="pln">float</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]),</span><span class="pln">float</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]),</span><span class="pln">float</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]))</span></li><li class="L3"><span class="pln">    rel</span><span class="pun">[</span><span class="str">'label'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">x</span><span class="pun">[</span><span class="lit">4</span><span class="pun">])</span></li><li class="L4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> rel</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">data </span><span class="pun">=</span><span class="pln"> spark</span><span class="pun">.</span><span class="pln">sparkContext</span><span class="pun">.</span><span class="pln">textFile</span><span class="pun">(</span><span class="str">"file:///usr/local/spark/iris.txt"</span><span class="pun">).</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> line</span><span class="pun">:</span><span class="pln"> line</span><span class="pun">.</span><span class="pln">split</span><span class="pun">(</span><span class="str">','</span><span class="pun">)).</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> p</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Row</span><span class="pun">(**</span><span class="pln">f</span><span class="pun">(</span><span class="pln">p</span><span class="pun">))).</span><span class="pln">toDF</span><span class="pun">()</span></li><li class="L8"><span class="pln">trainingData</span><span class="pun">,</span><span class="pln"> testData </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">randomSplit</span><span class="pun">([</span><span class="lit">0.7</span><span class="pun">,</span><span class="lit">0.3</span><span class="pun">])</span></li><li class="L9"><span class="pln">labelIndexer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">StringIndexer</span><span class="pun">().</span><span class="pln">setInputCol</span><span class="pun">(</span><span class="str">"label"</span><span class="pun">).</span><span class="pln">setOutputCol</span><span class="pun">(</span><span class="str">"indexedLabel"</span><span class="pun">).</span><span class="pln">fit</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span></li><li class="L0"><span class="pln">featureIndexer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">VectorIndexer</span><span class="pun">().</span><span class="pln">setInputCol</span><span class="pun">(</span><span class="str">"features"</span><span class="pun">).</span><span class="pln">setOutputCol</span><span class="pun">(</span><span class="str">"indexedFeatures"</span><span class="pun">).</span><span class="pln">fit</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span></li><li class="L1"><span class="pln">lr </span><span class="pun">=</span><span class="pln"> </span><span class="typ">LogisticRegression</span><span class="pun">().</span><span class="pln">setLabelCol</span><span class="pun">(</span><span class="str">"indexedLabel"</span><span class="pun">).</span><span class="pln">setFeaturesCol</span><span class="pun">(</span><span class="str">"indexedFeatures"</span><span class="pun">).</span><span class="pln">setMaxIter</span><span class="pun">(</span><span class="lit">50</span><span class="pun">)</span></li><li class="L2"><span class="pln">labelConverter </span><span class="pun">=</span><span class="pln">  </span><span class="typ">IndexToString</span><span class="pun">().</span><span class="pln">setInputCol</span><span class="pun">(</span><span class="str">"prediction"</span><span class="pun">).</span><span class="pln">setOutputCol</span><span class="pun">(</span><span class="str">"predictedLabel"</span><span class="pun">).</span><span class="pln">setLabels</span><span class="pun">(</span><span class="pln">labelIndexer</span><span class="pun">.</span><span class="pln">labels</span><span class="pun">)</span></li><li class="L3"><span class="pln">lrPipeline </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Pipeline</span><span class="pun">().</span><span class="pln">setStages</span><span class="pun">([</span><span class="pln">labelIndexer</span><span class="pun">,</span><span class="pln"> featureIndexer</span><span class="pun">,</span><span class="pln"> lr</span><span class="pun">,</span><span class="pln"> labelConverter</span><span class="pun">])</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>可以使用ParamGridBuilder方便构造参数网格。其中regParam参数定义规范化项的权重；elasticNetParam是
Elastic net 参数，取值介于0和1之间。elasticNetParam设置2个值，regParam设置3个值。最终将有(3 * 2) =
 6个不同的模型将被训练。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">paramGrid </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ParamGridBuilder</span><span class="pun">().</span><span class="pln">addGrid</span><span class="pun">(</span><span class="pln">lr</span><span class="pun">.</span><span class="pln">elasticNetParam</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0.2</span><span class="pun">,</span><span class="lit">0.8</span><span class="pun">]).</span><span class="pln">addGrid</span><span class="pun">(</span><span class="pln">lr</span><span class="pun">.</span><span class="pln">regParam</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0.01</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.5</span><span class="pun">]).</span><span class="pln">build</span><span class="pun">()</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>再接下来，构建针对整个机器学习工作流的交叉验证类，定义验证模型、参数网格，以及数据集的折叠数，并调用fit方法进行模型训练。其中，对于回归
问题评估器可选择RegressionEvaluator，二值数据可选择BinaryClassificationEvaluator，多分类问题可选
择MulticlassClassificationEvaluator。评估器里默认的评估准则可通过setMetricName方法重写。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">cv </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CrossValidator</span><span class="pun">().</span><span class="pln">setEstimator</span><span class="pun">(</span><span class="pln">lrPipeline</span><span class="pun">).</span><span class="pln">setEvaluator</span><span class="pun">(</span><span class="typ">MulticlassClassificationEvaluator</span><span class="pun">().</span><span class="pln">setLabelCol</span><span class="pun">(</span><span class="str">"indexedLabel"</span><span class="pun">).</span><span class="pln">setPredictionCol</span><span class="pun">(</span><span class="str">"prediction"</span><span class="pun">)).</span><span class="pln">setEstimatorParamMaps</span><span class="pun">(</span><span class="pln">paramGrid</span><span class="pun">).</span><span class="pln">setNumFolds</span><span class="pun">(</span><span class="lit">3</span><span class="pun">)</span><span class="pln"> </span></li><li class="L1"><span class="pln">cvModel </span><span class="pun">=</span><span class="pln"> cv</span><span class="pun">.</span><span class="pln">fit</span><span class="pun">(</span><span class="pln">trainingData</span><span class="pun">)</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>接下来，调动transform方法对测试数据进行预测，并打印结果及精度。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">lrPredictions</span><span class="pun">=</span><span class="pln">cvModel</span><span class="pun">.</span><span class="pln">transform</span><span class="pun">(</span><span class="pln">testData</span><span class="pun">)</span></li><li class="L1"><span class="pln">lrPreRel </span><span class="pun">=</span><span class="pln"> lrPredictions</span><span class="pun">.</span><span class="pln">select</span><span class="pun">(</span><span class="str">"predictedLabel"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"label"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"features"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"probability"</span><span class="pun">).</span><span class="pln">collect</span><span class="pun">()</span></li><li class="L2"><span class="kwd">for</span><span class="pln"> item </span><span class="kwd">in</span><span class="pln"> lrPreRel</span><span class="pun">:</span></li><li class="L3"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="pln">str</span><span class="pun">(</span><span class="pln">item</span><span class="pun">[</span><span class="str">'label'</span><span class="pun">])+</span><span class="str">','</span><span class="pun">+</span><span class="pln">str</span><span class="pun">(</span><span class="pln">item</span><span class="pun">[</span><span class="str">'features'</span><span class="pun">])+</span><span class="str">'--&gt;prob='</span><span class="pun">+</span><span class="pln">str</span><span class="pun">(</span><span class="pln">item</span><span class="pun">[</span><span class="str">'probability'</span><span class="pun">])+</span><span class="str">',predictedLabel'</span><span class="pun">+</span><span class="pln">str</span><span class="pun">(</span><span class="pln">item</span><span class="pun">[</span><span class="str">'predictedLabel'</span><span class="pun">]))</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="typ">Iris</span><span class="pun">-</span><span class="pln">setosa</span><span class="pun">,[</span><span class="lit">4.7</span><span class="pun">,</span><span class="lit">3.2</span><span class="pun">,</span><span class="lit">1.6</span><span class="pun">,</span><span class="lit">0.2</span><span class="pun">]--&gt;</span><span class="pln">prob</span><span class="pun">=[</span><span class="lit">0.0124531315584</span><span class="pun">,</span><span class="lit">3.61495729015e-06</span><span class="pun">,</span><span class="lit">0.987543253484</span><span class="pun">],</span><span class="pln">predictedLabelIris</span><span class="pun">-</span><span class="pln">setosa</span></li><li class="L6"><span class="typ">Iris</span><span class="pun">-</span><span class="pln">setosa</span><span class="pun">,[</span><span class="lit">4.8</span><span class="pun">,</span><span class="lit">3.0</span><span class="pun">,</span><span class="lit">1.4</span><span class="pun">,</span><span class="lit">0.1</span><span class="pun">]--&gt;</span><span class="pln">prob</span><span class="pun">=[</span><span class="lit">0.0189306218612</span><span class="pun">,</span><span class="lit">4.68811238788e-06</span><span class="pun">,</span><span class="lit">0.981064690026</span><span class="pun">],</span><span class="pln">predictedLabelIris</span><span class="pun">-</span><span class="pln">setosa</span></li><li class="L7"><span class="typ">Iris</span><span class="pun">-</span><span class="pln">setosa</span><span class="pun">,[</span><span class="lit">4.8</span><span class="pun">,</span><span class="lit">3.4</span><span class="pun">,</span><span class="lit">1.9</span><span class="pun">,</span><span class="lit">0.2</span><span class="pun">]--&gt;</span><span class="pln">prob</span><span class="pun">=[</span><span class="lit">0.00954865220928</span><span class="pun">,</span><span class="lit">2.15004457391e-06</span><span class="pun">,</span><span class="lit">0.990449197746</span><span class="pun">],</span><span class="pln">predictedLabelIris</span><span class="pun">-</span><span class="pln">setosa</span></li><li class="L8"><span class="typ">Iris</span><span class="pun">-</span><span class="pln">setosa</span><span class="pun">,[</span><span class="lit">4.9</span><span class="pun">,</span><span class="lit">3.1</span><span class="pun">,</span><span class="lit">1.5</span><span class="pun">,</span><span class="lit">0.1</span><span class="pun">]--&gt;</span><span class="pln">prob</span><span class="pun">=[</span><span class="lit">0.0164788072778</span><span class="pun">,</span><span class="lit">3.34188478227e-06</span><span class="pun">,</span><span class="lit">0.983517850837</span><span class="pun">],</span><span class="pln">predictedLabelIris</span><span class="pun">-</span><span class="pln">setosa</span></li><li class="L9"><span class="typ">Iris</span><span class="pun">-</span><span class="pln">versicolor</span><span class="pun">,[</span><span class="lit">5.0</span><span class="pun">,</span><span class="lit">2.0</span><span class="pun">,</span><span class="lit">3.5</span><span class="pun">,</span><span class="lit">1.0</span><span class="pun">]--&gt;</span><span class="pln">prob</span><span class="pun">=[</span><span class="lit">0.699989993024</span><span class="pun">,</span><span class="lit">0.295573613818</span><span class="pun">,</span><span class="lit">0.00443639315824</span><span class="pun">],</span><span class="pln">predictedLabelIris</span><span class="pun">-</span><span class="pln">versicolor</span></li><li class="L0"><span class="typ">Iris</span><span class="pun">-</span><span class="pln">setosa</span><span class="pun">,[</span><span class="lit">5.0</span><span class="pun">,</span><span class="lit">3.0</span><span class="pun">,</span><span class="lit">1.6</span><span class="pun">,</span><span class="lit">0.2</span><span class="pun">]--&gt;</span><span class="pln">prob</span><span class="pun">=[</span><span class="lit">0.0385031367429</span><span class="pun">,</span><span class="lit">1.48064614591e-05</span><span class="pun">,</span><span class="lit">0.961482056796</span><span class="pun">],</span><span class="pln">predictedLabelIris</span><span class="pun">-</span><span class="pln">setosa</span></li><li class="L1"><span class="typ">Iris</span><span class="pun">-</span><span class="pln">setosa</span><span class="pun">,[</span><span class="lit">5.0</span><span class="pun">,</span><span class="lit">3.4</span><span class="pun">,</span><span class="lit">1.6</span><span class="pun">,</span><span class="lit">0.4</span><span class="pun">]--&gt;</span><span class="pln">prob</span><span class="pun">=[</span><span class="lit">0.0125473025277</span><span class="pun">,</span><span class="lit">4.16328341655e-06</span><span class="pun">,</span><span class="lit">0.987448534189</span><span class="pun">],</span><span class="pln">predictedLabelIris</span><span class="pun">-</span><span class="pln">setosa</span></li><li class="L2"><span class="pun">......</span><span class="pln">  </span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">evaluator </span><span class="pun">=</span><span class="pln"> </span><span class="typ">MulticlassClassificationEvaluator</span><span class="pun">().</span><span class="pln">setLabelCol</span><span class="pun">(</span><span class="str">"indexedLabel"</span><span class="pun">).</span><span class="pln">setPredictionCol</span><span class="pun">(</span><span class="str">"prediction"</span><span class="pun">)</span></li><li class="L5"><span class="pln">lrAccuracy </span><span class="pun">=</span><span class="pln"> evaluator</span><span class="pun">.</span><span class="pln">evaluate</span><span class="pun">(</span><span class="pln">lrPredictions</span><span class="pun">)</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>最后，还可以获取最优的逻辑斯蒂回归模型，并查看其具体的参数:</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> bestModel</span><span class="pun">=</span><span class="pln"> cvModel</span><span class="pun">.</span><span class="pln">bestModel</span></li><li class="L1"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> lrModel </span><span class="pun">=</span><span class="pln"> bestModel</span><span class="pun">.</span><span class="pln">stages</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span></li><li class="L2"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Coefficients: "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">lrModel</span><span class="pun">.</span><span class="pln">coefficientMatrix</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">"Intercept: "</span><span class="pun">+</span><span class="pln">str</span><span class="pun">(</span><span class="pln">lrModel</span><span class="pun">.</span><span class="pln">interceptVector</span><span class="pun">)+</span><span class="pln"> </span><span class="str">"numClasses: "</span><span class="pun">+</span><span class="pln">str</span><span class="pun">(</span><span class="pln">lrModel</span><span class="pun">.</span><span class="pln">numClasses</span><span class="pun">)+</span><span class="str">"numFeatures: "</span><span class="pun">+</span><span class="pln">str</span><span class="pun">(</span><span class="pln">lrModel</span><span class="pun">.</span><span class="pln">numFeatures</span><span class="pun">))</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="typ">Coefficients</span><span class="pun">:</span><span class="pln"> </span><span class="typ">DenseMatrix</span><span class="pun">([[</span><span class="pln"> </span><span class="lit">0.57547193</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">0.3505967</span><span class="pln"> </span><span class="pun">,</span><span class="pln">  </span><span class="lit">0.09896991</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">0.01073066</span><span class="pun">],</span></li><li class="L5"><span class="pln">             </span><span class="pun">[-</span><span class="lit">0.00950188</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">2.63413762</span><span class="pun">,</span><span class="pln">  </span><span class="lit">0.96959059</span><span class="pun">,</span><span class="pln">  </span><span class="lit">3.81872308</span><span class="pun">],</span></li><li class="L6"><span class="pln">             </span><span class="pun">[-</span><span class="lit">0.63212011</span><span class="pun">,</span><span class="pln">  </span><span class="lit">3.61557516</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1.24757936</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">2.20366198</span><span class="pun">]])</span><span class="typ">Intercept</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0.0988591576682</span><span class="pun">,-</span><span class="lit">0.14796420754</span><span class="pun">,</span><span class="lit">0.0491050498716</span><span class="pun">]</span><span class="pln">numClasses</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3numFeatures</span><span class="pun">:</span><span class="pln"> </span><span class="lit">4</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> lr</span><span class="pun">.</span><span class="pln">explainParam</span><span class="pun">(</span><span class="pln">lr</span><span class="pun">.</span><span class="pln">regParam</span><span class="pun">)</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="str">'regParam: regularization parameter (&gt;= 0). (default: 0.0)'</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> lr</span><span class="pun">.</span><span class="pln">explainParam</span><span class="pun">(</span><span class="pln">lr</span><span class="pun">.</span><span class="pln">elasticNetParam</span><span class="pun">)</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="str">'elasticNetParam: the ElasticNet mixing parameter, in range [0, 1]. For alpha = 0, the penalty is an L2 penalty. For alpha = 1, it is an L1 penalty. (default: 0.0)'</span></li><li class="L6"><span class="pln">&nbsp;</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
			</div><!-- .entry-content -->

	<footer class="entry-footer">
		<div class="entry-author">
			<div class="author-title">本文作者</div>
			
		<div class="author-avatar"><img src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/2.jpg" alt="阮榕城" class="avatar avatar-thumbnail wp-user-avatar wp-user-avatar-thumbnail alignnone photo"></div>
		<div class="author-info">
			<p class="author-name"><a href="http://dblab.xmu.edu.cn/blog/author/ruanrongcheng/">阮榕城</a></p>
			<p class="author-desc">磨人的小妖精！</p>
			<p class="author-contact"><a href="http://www.nekomiao.me/" target="_blank" title="个人主页" class="homepage"><i class="fa fa-home"></i>www.nekomiao.me</a><i class="fa fa-envelope"></i><span class="envelope">moc.qq@crnaur</span></p>
		</div>
			</div>
		<div class="entry-info">
			<span class="permalink"><i class="fa fa-external-link"></i> <a href="http://dblab.xmu.edu.cn/blog/1782-2/" title="Spark2.1.0入门：模型选择和超参数调整(Python版)">http://dblab.xmu.edu.cn/blog/1782-2/</a></span><span class="category"><i class="fa fa-folder-open-o"></i> <a href="http://dblab.xmu.edu.cn/blog/category/big-data/" rel="category tag">大数据</a></span>		</div>
		<div class="yarpp-related yarpp-related-none">
</div>
	</footer><!-- .entry-footer -->
</article><!-- #post-## -->
			</div>
</div><!-- .row -->

	<div class="row">
		<div class="col-sm-3"></div>
		<div class="col-sm-9 site-footer">
			© 2014 <a href="http://dblab.xmu.edu.cn/">厦大数据库实验室</a>
					</div>
	</div>
</div><!-- .container -->
<link rel="stylesheet" id="yarppRelatedCss-css" href="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/related.css" type="text/css" media="all">
<script type="text/javascript" src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/prettify.js"></script>
<script type="text/javascript" src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/power.js"></script>
<script type="text/javascript" src="Spark2.1.0%E5%85%A5%E9%97%A8%EF%BC%9A%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E8%B6%85%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/wp-embed.js"></script>

<div class="back-to-top" id="back-to-top" title="嗖的就上去了！"><span><i class="fa fa-chevron-up"></i></span></div></body></html>