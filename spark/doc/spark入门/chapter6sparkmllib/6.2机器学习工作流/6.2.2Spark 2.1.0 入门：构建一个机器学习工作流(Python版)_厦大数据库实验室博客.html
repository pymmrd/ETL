<!DOCTYPE html>
<html lang="zh-CN"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spark 2.1.0 入门：构建一个机器学习工作流(Python版)_厦大数据库实验室博客</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<link rel="dns-prefetch" href="http://cdn.staticfile.org/">
<link rel="dns-prefetch" href="http://s.w.org/">
<link rel="stylesheet" id="yarppWidgetCss-css" href="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/widget.css" type="text/css" media="all">
<link rel="stylesheet" id="wp-quicklatex-format-css" href="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/quicklatex-format.css" type="text/css" media="all">
<link rel="stylesheet" id="bootstrap-css" href="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/bootstrap.css" type="text/css" media="all">
<link rel="stylesheet" id="font-awesome-css" href="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/font-awesome.css" type="text/css" media="all">
<link rel="stylesheet" id="power-css" href="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/style.css" type="text/css" media="all">
<link rel="stylesheet" id="google-code-prettify-css" href="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/prettify.css" type="text/css" media="all">
<script type="text/javascript" async="" charset="utf-8" src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/core.js"></script><script src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/hm.js"></script><script src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/z_stat.js"></script><script type="text/javascript" src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/jquery_002.js"></script>
<script type="text/javascript" src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/jquery.js"></script>
<script type="text/javascript" src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/jquery-migrate.js"></script>
<script type="text/javascript" src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/wp-quicklatex-frontend.js"></script>
<link rel="https://api.w.org/" href="http://dblab.xmu.edu.cn/blog/wp-json/">
<link rel="prev" title="Spark2.1.0入门：机器学习工作流(ML Pipelines)(Python版)" href="http://dblab.xmu.edu.cn/blog/1763-2/">
<link rel="next" title="Spark上机练习题：统计微博信息" href="http://dblab.xmu.edu.cn/blog/1765-2/">
<link rel="canonical" href="http://dblab.xmu.edu.cn/blog/1764-2/">
<link rel="alternate" type="application/json+oembed" href="http://dblab.xmu.edu.cn/blog/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fdblab.xmu.edu.cn%2Fblog%2F1764-2%2F">
<!--[if lt IE 9]>
<script src="http://dblab.xmu.edu.cn/blog/wp-content/themes/power/js/html5shiv.js"></script>
<![endif]-->
</head>

<body class="post-template-default single single-post postid-1764 single-format-standard group-blog">
<div class="container site-page">

<div class="row">
	<div class="col-sm-3 site-infos">
		<h4 class="site-title">
			<a href="http://dblab.xmu.edu.cn/blog/" title="厦大数据库实验室博客" rel="home">厦大数据库实验室博客</a>
		</h4>
		<div class="site-description">总结、分享、收获<p><a href="http://dblab.xmu.edu.cn/" title="厦大数据库实验室">实验室主页</a></p></div>

		<nav class="main-navigation" role="navigation">
			<div class="menu-primary-container"><ul id="menu-primary" class="menu menu-level-1"><li id="menu-item-80" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/">首页</a></li>
<li id="menu-item-85" class="menu-item item-level-1 current-path"><a href="http://dblab.xmu.edu.cn/blog/category/big-data/">大数据</a></li>
<li id="menu-item-676" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/category/databases/">数据库</a></li>
<li id="menu-item-87" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/category/data-mining/">数据挖掘</a></li>
<li id="menu-item-86" class="menu-item item-level-1"><a href="http://dblab.xmu.edu.cn/blog/category/others/">其他</a></li>
</ul></div>		</nav><!-- #site-navigation -->

		<div class="search"><form role="search" method="get" class="search-form" action="http://dblab.xmu.edu.cn/blog/">
				<label>
					<span class="screen-reader-text">搜索：</span>
					<input class="search-field" placeholder="搜索…" name="s" type="search">
				</label>
				<input class="search-submit" value="搜索" type="submit">
			</form></div>
	</div>
	<div class="col-sm-9 site-main">

					<article id="post-1764" class="post-1764 post type-post status-publish format-standard hentry category-big-data">
	<header class="entry-header">
		<h1 class="entry-title">Spark 2.1.0 入门：构建一个机器学习工作流(Python版)</h1>

		<div class="entry-meta">
			<span class="author"><i class="fa fa-user"></i> 阮榕城</span><span class="date"><i class="fa fa-calendar"></i> <time datetime="2017-12-17T21:35:22+00:00">2017年12月17日</time> <span class="updated">(updated: <time class="updated" datetime="2017-12-18T09:42:51+00:00">2017年12月18日</time>)</span></span><span class="views" id="views"><i class="fa fa-eye"></i> 2235</span>		</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

	<div class="entry-content">
		<div class="bigdata-book">
			<a href="http://dblab.xmu.edu.cn/post/5899/" title="2019年1月20日寒假大数据师资培训班" target="_blank"><img src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/peixunban2019-01-20.jpg" alt="2019年1月20日寒假大数据师资培训班"></a>
		</div>
		<p>【版权声明】博客内容由厦门大学数据库实验室拥有版权，未经允许，请勿转载！<br>
<a href="http://dblab.xmu.edu.cn/blog/1709-2/" target="_blank">返回Spark教程首页</a></p>
<p><span id="more-1764"></span></p>
<h1>工作流(ML Pipelines)例子</h1>
<p>本节以逻辑斯蒂回归为例，构建一个典型的机器学习过程，来具体介绍一下工作流是如何应用的。我们的目的是查找出所有包含”spark”的句子，即将
包含”spark”的句子的标签设为1，没有”spark”的句子的标签设为0。Spark2.0起，SQLContext、HiveContext已经
不再推荐使用，改以SparkSession代之，故本文中不再使用SQLContext来进行相关的操作，关于SparkSession的具体详情，这
里不再赘述，可以参看Spark2.0的<a href="http://spark.apache.org/docs/latest/sql-programming-guide.html" target="_blank">官方文档</a></p>
<p>Spark2.0以上版本的pyspark创建一个名为spark的SparkSession对象，当需要手工创建时，SparkSession可以由其伴生对象的builder()方法创建出来，如下代码段所示：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-pyspark prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">spark </span><span class="pun">=</span><span class="pln"> </span><span class="typ">SparkSession</span><span class="pun">.</span><span class="pln">builder</span><span class="pun">.</span><span class="pln">master</span><span class="pun">(</span><span class="str">"local"</span><span class="pun">).</span><span class="pln">appName</span><span class="pun">(</span><span class="str">"Word Count"</span><span class="pun">).</span><span class="pln">getOrCreate</span><span class="pun">()</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">pyspark</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>下文中，我们默认名为spark的SparkSession已经创建。<br>
pyspark.ml依赖numpy包，Ubuntu 自带python3是没有numpy的，执行如下命令安装：</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-bash prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">sudo </span><span class="pln">pip3 install numpy</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Shell 命令</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>然后，我们引入要包含的包并构建训练数据集。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">ml </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Pipeline</span></li><li class="L1"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">ml</span><span class="pun">.</span><span class="pln">classification </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">LogisticRegression</span></li><li class="L2"><span class="kwd">from</span><span class="pln"> pyspark</span><span class="pun">.</span><span class="pln">ml</span><span class="pun">.</span><span class="pln">feature </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">HashingTF</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Tokenizer</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com"># Prepare training documents from a list of (id, text, label) tuples.</span></li><li class="L5"><span class="pln">training </span><span class="pun">=</span><span class="pln"> spark</span><span class="pun">.</span><span class="pln">createDataFrame</span><span class="pun">([</span></li><li class="L6"><span class="pln">    </span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="str">"a b c d e spark"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.0</span><span class="pun">),</span></li><li class="L7"><span class="pln">    </span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">"b d"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.0</span><span class="pun">),</span></li><li class="L8"><span class="pln">    </span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="str">"spark f g h"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.0</span><span class="pun">),</span></li><li class="L9"><span class="pln">    </span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="str">"hadoop mapreduce"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.0</span><span class="pun">)</span></li><li class="L0"><span class="pun">],</span><span class="pln"> </span><span class="pun">[</span><span class="str">"id"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"text"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"label"</span><span class="pun">])</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>在这一步中我们要定义 Pipeline 中的各个工作流阶段PipelineStage，包括转换器和评估器，具体的，包含tokenizer, hashingTF和lr三个步骤。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">tokenizer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Tokenizer</span><span class="pun">(</span><span class="pln">inputCol</span><span class="pun">=</span><span class="str">"text"</span><span class="pun">,</span><span class="pln"> outputCol</span><span class="pun">=</span><span class="str">"words"</span><span class="pun">)</span></li><li class="L1"><span class="pln">hashingTF </span><span class="pun">=</span><span class="pln"> </span><span class="typ">HashingTF</span><span class="pun">(</span><span class="pln">inputCol</span><span class="pun">=</span><span class="pln">tokenizer</span><span class="pun">.</span><span class="pln">getOutputCol</span><span class="pun">(),</span><span class="pln"> outputCol</span><span class="pun">=</span><span class="str">"features"</span><span class="pun">)</span></li><li class="L2"><span class="pln">lr </span><span class="pun">=</span><span class="pln"> </span><span class="typ">LogisticRegression</span><span class="pun">(</span><span class="pln">maxIter</span><span class="pun">=</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> regParam</span><span class="pun">=</span><span class="lit">0.001</span><span class="pun">)</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>有了这些处理特定问题的转换器和评估器，接下来就可以按照具体的处理逻辑有序的组织PipelineStages 并创建一个Pipeline。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">pipeline </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Pipeline</span><span class="pun">(</span><span class="pln">stages</span><span class="pun">=[</span><span class="pln">tokenizer</span><span class="pun">,</span><span class="pln"> hashingTF</span><span class="pun">,</span><span class="pln"> lr</span><span class="pun">])</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>现在构建的Pipeline本质上是一个Estimator，在它的fit（）方法运行之后，它将产生一个PipelineModel，它是一个Transformer。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">model </span><span class="pun">=</span><span class="pln"> pipeline</span><span class="pun">.</span><span class="pln">fit</span><span class="pun">(</span><span class="pln">training</span><span class="pun">)</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>我们可以看到，model的类型是一个PipelineModel，这个管道模型将在测试数据的时候使用。所以接下来，我们先构建测试数据。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">test </span><span class="pun">=</span><span class="pln"> spark</span><span class="pun">.</span><span class="pln">createDataFrame</span><span class="pun">([</span></li><li class="L1"><span class="pln">    </span><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="str">"spark i j k"</span><span class="pun">),</span></li><li class="L2"><span class="pln">    </span><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="str">"l m n"</span><span class="pun">),</span></li><li class="L3"><span class="pln">    </span><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="str">"spark hadoop spark"</span><span class="pun">),</span></li><li class="L4"><span class="pln">    </span><span class="pun">(</span><span class="lit">7</span><span class="pun">,</span><span class="pln"> </span><span class="str">"apache hadoop"</span><span class="pun">)</span></li><li class="L5"><span class="pun">],</span><span class="pln"> </span><span class="pun">[</span><span class="str">"id"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"text"</span><span class="pun">])</span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>然后，我们调用我们训练好的PipelineModel的transform（）方法，让测试数据按顺序通过拟合的工作流，生成我们所需要的预测结果。</p>
<div class="code-pretty-container"><pre class="prettyprint linenums lang-python prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">prediction </span><span class="pun">=</span><span class="pln"> model</span><span class="pun">.</span><span class="pln">transform</span><span class="pun">(</span><span class="pln">test</span><span class="pun">)</span></li><li class="L1"><span class="pln">selected </span><span class="pun">=</span><span class="pln"> prediction</span><span class="pun">.</span><span class="pln">select</span><span class="pun">(</span><span class="str">"id"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"text"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"probability"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"prediction"</span><span class="pun">)</span></li><li class="L2"><span class="kwd">for</span><span class="pln"> row </span><span class="kwd">in</span><span class="pln"> selected</span><span class="pun">.</span><span class="pln">collect</span><span class="pun">():</span></li><li class="L3"><span class="pln">    rid</span><span class="pun">,</span><span class="pln"> text</span><span class="pun">,</span><span class="pln"> prob</span><span class="pun">,</span><span class="pln"> prediction </span><span class="pun">=</span><span class="pln"> row</span></li><li class="L4"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">"(%d, %s) --&gt; prob=%s, prediction=%f"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">rid</span><span class="pun">,</span><span class="pln"> text</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">prob</span><span class="pun">),</span><span class="pln"> prediction</span><span class="pun">))</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> spark i j k</span><span class="pun">)</span><span class="pln"> </span><span class="pun">--&gt;</span><span class="pln"> prob</span><span class="pun">=[</span><span class="lit">0.155543713844</span><span class="pun">,</span><span class="lit">0.844456286156</span><span class="pun">],</span><span class="pln"> prediction</span><span class="pun">=</span><span class="lit">1.000000</span></li><li class="L7"><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> l m n</span><span class="pun">)</span><span class="pln"> </span><span class="pun">--&gt;</span><span class="pln"> prob</span><span class="pun">=[</span><span class="lit">0.830707735211</span><span class="pun">,</span><span class="lit">0.169292264789</span><span class="pun">],</span><span class="pln"> prediction</span><span class="pun">=</span><span class="lit">0.000000</span></li><li class="L8"><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> spark hadoop spark</span><span class="pun">)</span><span class="pln"> </span><span class="pun">--&gt;</span><span class="pln"> prob</span><span class="pun">=[</span><span class="lit">0.0696218406195</span><span class="pun">,</span><span class="lit">0.93037815938</span><span class="pun">],</span><span class="pln"> prediction</span><span class="pun">=</span><span class="lit">1.000000</span></li><li class="L9"><span class="pun">(</span><span class="lit">7</span><span class="pun">,</span><span class="pln"> apache hadoop</span><span class="pun">)</span><span class="pln"> </span><span class="pun">--&gt;</span><span class="pln"> prob</span><span class="pun">=[</span><span class="lit">0.981518350351</span><span class="pun">,</span><span class="lit">0.018481649649</span><span class="pun">],</span><span class="pln"> prediction</span><span class="pun">=</span><span class="lit">0.000000</span><span class="pln">        </span></li></ol></pre><div class="code-pretty-toolbar"><span class="title">Python</span><a href="javascript:void(0);" title="复制代码" class="tool clipboard"><i class="fa fa-files-o"></i></a><a href="javascript:void(0);" title="查看纯文本代码" class="tool view-source"><i class="fa fa-code"></i></a><a href="javascript:void(0);" title="返回代码高亮" class="tool back-to-pretty"><i class="fa fa-undo"></i></a><span class="msg"></span></div></div>
<p>通过上述结果，我们可以看到，第4句和第6句中都包含”spark”，其中第六句的预测是1，与我们希望的相符；而第4句虽然预测的依然是0，但是
通过概率我们可以看到，第4句有46%的概率预测是1，而第5句、第7句分别只有7%和2%的概率预测为1，这是由于训练数据集较少，如果有更多的测试数
据进行学习，预测的准确率将会有显著提升。</p>
			</div><!-- .entry-content -->

	<footer class="entry-footer">
		<div class="entry-author">
			<div class="author-title">本文作者</div>
			
		<div class="author-avatar"><img src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/2.jpg" alt="阮榕城" class="avatar avatar-thumbnail wp-user-avatar wp-user-avatar-thumbnail alignnone photo"></div>
		<div class="author-info">
			<p class="author-name"><a href="http://dblab.xmu.edu.cn/blog/author/ruanrongcheng/">阮榕城</a></p>
			<p class="author-desc">磨人的小妖精！</p>
			<p class="author-contact"><a href="http://www.nekomiao.me/" target="_blank" title="个人主页" class="homepage"><i class="fa fa-home"></i>www.nekomiao.me</a><i class="fa fa-envelope"></i><span class="envelope">moc.qq@crnaur</span></p>
		</div>
			</div>
		<div class="entry-info">
			<span class="permalink"><i class="fa fa-external-link"></i> <a href="http://dblab.xmu.edu.cn/blog/1764-2/" title="Spark 2.1.0 入门：构建一个机器学习工作流(Python版)">http://dblab.xmu.edu.cn/blog/1764-2/</a></span><span class="category"><i class="fa fa-folder-open-o"></i> <a href="http://dblab.xmu.edu.cn/blog/category/big-data/" rel="category tag">大数据</a></span>		</div>
		<div class="yarpp-related yarpp-related-none">
</div>
	</footer><!-- .entry-footer -->
</article><!-- #post-## -->
			</div>
</div><!-- .row -->

	<div class="row">
		<div class="col-sm-3"></div>
		<div class="col-sm-9 site-footer">
			© 2014 <a href="http://dblab.xmu.edu.cn/">厦大数据库实验室</a>
					</div>
	</div>
</div><!-- .container -->
<link rel="stylesheet" id="yarppRelatedCss-css" href="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/related.css" type="text/css" media="all">
<script type="text/javascript" src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/prettify.js"></script>
<script type="text/javascript" src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/power.js"></script>
<script type="text/javascript" src="6.3Spark%202.1.0%20%E5%85%A5%E9%97%A8%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E4%BD%9C%E6%B5%81(Python%E7%89%88)_%E5%8E%A6%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%8D%9A%E5%AE%A2_files/wp-embed.js"></script>

<div class="back-to-top" id="back-to-top" title="嗖的就上去了！"><span><i class="fa fa-chevron-up"></i></span></div></body></html>